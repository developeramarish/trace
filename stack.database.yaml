version: '3.9'

networks:
  database:
    driver: overlay
    attachable: true
    name: database-net

services:
  stream:
    image: mongo:5.0-focal
    environment:
      MONGO_INITDB_DATABASE: trace
      MONGO_INITDB_ROOT_USERNAME: trace
      MONGO_INITDB_ROOT_PASSWORD: trace
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
        reservations:
          memory: 32M
    ports:
      - 27017:27017
    networks:
      - database
    volumes:
      - '${STORE_ROOT}/mongodb:/data/db'
  operation:
    image: postgis/postgis:13-3.2-alpine
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.1'
          memory: 128M
        reservations:
          memory: 32M
    ports:
      - 5432:5432
    networks:
      - database
    volumes:
      - '/etc/localtime:/etc/localtime:ro'
      - '/etc/timezone:/etc/timezone:ro'
      - '${STORE_ROOT}/postgres:/var/lib/postgresql/data/pgdata'
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_USER: trace
      POSTGRES_PASSWORD: trace
      POSTGRES_DB: trace
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}']
      interval: 10s
      timeout: 5s
      retries: 5
